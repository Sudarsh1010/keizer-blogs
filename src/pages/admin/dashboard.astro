---
import BlogList from '../../components/admin/blog-list.astro';
import { fetchBlogs } from '../../utils/services/blog-service';
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { actions } from 'astro:actions';
import { Book, Plus, Search, ChevronLeft, ChevronRight, ChevronsLeft, ChevronsRight } from 'lucide-react'

const DEFAULT_PAGE_SIZE = 5;
const pageSize = Number(Astro.url.searchParams.get('pageSize') || DEFAULT_PAGE_SIZE);
const currentPage = Number(Astro.url.searchParams.get('page') || '1');
const searchQuery = Astro.url.searchParams.get('search') || '';

const { data, error } = await Astro.callAction(actions.blogs.fetchBlogs, {
  page: currentPage,
  pageSize: pageSize,
  search: searchQuery,
});

if (error) {
  console.error("Error fetching blogs:", error);
}

let blogs = data?.blogs || [];
let totalBlogs = data?.total || 0;

// const searchResult = Astro.getActionResult(actions.blogs.searchBlogs);
// if (searchResult && !searchResult.error) {
// console.log("searchResult", searchResult);
// blogs = searchResult.data.blogs;
// }


// let totalBlogs = 0;
// let blogs: any[] = [];

// try {

//   const result = await fetchBlogs(currentPage, PAGE_SIZE, searchQuery);
//   blogs = result.blogs;
//   totalBlogs = result.total;
// } catch (err) {
//   console.error("Error fetching blogs:", err);
// }

const totalPages = Math.ceil(totalBlogs / pageSize);
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Keizer Blogs - Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  </head>
  <body class="bg-gray-50 text-gray-900 font-['Inter',sans-serif] min-h-screen">
    <nav class="border-b border-gray-200 bg-white shadow-sm">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-2">
            <Book className="h-6 w-6 text-blue-600" />
            <span class="text-xl font-bold text-gray-900">Keizer Blogs</span>
          </div>
          <Button>
            <Plus className="h-5 w-5 mr-2" />
            New Blog
          </Button>
        </div>
      </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
      <!-- <form class="mb-8 flex items-center" method="POST" action={actions.blogs.searchBlogs}>
        <input type="hidden" name="page" value={currentPage} />
        <input type="hidden" name="pageSize" value={PAGE_SIZE} />
        <div class="relative flex-grow">
          <Input
            type="text"
            name="search"
            placeholder="Search blogs by title..."
            value={searchQuery}
            className="w-full pr-20 pl-4 py-2"
          />
          <Button type="submit" className="absolute right-0 top-0 h-full">
            <Search className="h-5 w-5 mr-2" />
            Search
          </Button>
        </div>
      </form> -->
      <form class="mb-8 flex items-center" method="GET" action="">
        <input type="hidden" name="page" value="1" />
        <input type="hidden" name="pageSize" value={pageSize} />
        <div class="relative flex-grow">
          <input
            type="text"
            name="search"
            placeholder="Search blogs by title..."
            value={searchQuery}
            class="w-full pr-20 pl-4 py-2"
          />
          <button type="submit" class="absolute right-0 top-0 h-full btn">
            <Search className="h-5 w-5 mr-2" />
            Search
          </button>
        </div>
      </form>
      
      <main>
        <section class="bg-white rounded-lg shadow-md p-6 mb-8">
          <h1 class="text-2xl font-semibold mb-6 text-gray-800">All Blogs</h1>
          {blogs.length > 0 ? (
            <>
              <BlogList blogs={blogs} />
              
              <div class="mt-8 flex justify-center items-center space-x-2">
                {currentPage > 1 ? (
                  <a href={`?page=1&pageSize=${pageSize}&search=${searchQuery}`} class="btn" aria-label="First Page">
                    <Button
                      variant="outline"
                      size="sm"
                    >
                      <ChevronsLeft className="h-5 w-5" />
                    </Button>
                  </a>
                ) : (
                  <Button
                    variant="outline"
                    size="sm"
                    disabled
                  >
                    <ChevronsLeft className="h-5 w-5" />
                  </Button>
                )}
              
                {currentPage > 1 ? (
                  <a href={`?page=${currentPage - 1}&pageSize=${pageSize}&search=${searchQuery}`} class="btn" aria-label="Previous Page">
                    <Button
                      variant="outline"
                      size="sm"
                    >
                      <ChevronLeft className="h-5 w-5" />
                    </Button>
                  </a>
                ) : (
                  <Button
                    variant="outline"
                    size="sm"
                    disabled
                  >
                    <ChevronLeft className="h-5 w-5" />
                  </Button>
                )}
              
                <span class="text-gray-700 font-medium">{currentPage} of {totalPages}</span>
              
                {currentPage < totalPages ? (
                  <a href={`?page=${currentPage + 1}&pageSize=${pageSize}&search=${searchQuery}`} class="btn" aria-label="Next Page">
                    <Button
                      variant="outline"
                      size="sm"
                    >
                      <ChevronRight className="h-5 w-5" />
                    </Button>
                  </a>
                ) : (
                  <Button
                    variant="outline"
                    size="sm"
                    disabled
                  >
                    <ChevronRight className="h-5 w-5" />
                  </Button>
                )}
              
                {currentPage < totalPages ? (
                  <a href={`?page=${totalPages}&pageSize=${pageSize}&search=${searchQuery}`} class="btn" aria-label="Last Page">
                    <Button
                      variant="outline"
                      size="sm"
                    >
                      <ChevronsRight className="h-5 w-5" />
                    </Button>
                  </a>
                ) : (
                  <Button
                    variant="outline"
                    size="sm"
                    disabled
                  >
                    <ChevronsRight className="h-5 w-5" />
                  </Button>
                )}
              </div>
            </>
          ) : (
            <p class="text-center text-gray-500 py-8">No blogs found</p>
          )}
        </section>
      </main>
    </div>
    
    <footer class="text-center py-4 text-gray-600 text-sm">
      &copy; 2023 Keizer Blogs. All rights reserved.
    </footer>
  </body>
</html>
